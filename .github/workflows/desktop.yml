name: Desktop CI

# Triggers:
#   • Every push / PR that touches apps/desktop/, pnpm-lock.yaml, or this file
#   • Version tags:  desktop-v1.2.3  → creates a GitHub Release
#   • Manual run via Actions UI
on:
  push:
    branches: [main, master]
    paths:
      - 'apps/desktop/**'
      - 'pnpm-lock.yaml'
      - '.github/workflows/desktop.yml'
    tags:
      - 'desktop-v[0-9]+.[0-9]+.[0-9]+'
  pull_request:
    branches: [main, master]
    paths:
      - 'apps/desktop/**'
      - 'pnpm-lock.yaml'
      - '.github/workflows/desktop.yml'
  workflow_dispatch:

# Required for tauri-action to create / update GitHub Releases
permissions:
  contents: write

jobs:
  # ──────────────────────────────────────────────────────────────────────────
  # 1. Fast frontend typecheck (runs once, not per-platform)
  # ──────────────────────────────────────────────────────────────────────────
  typecheck:
    name: Typecheck
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@v4

      - uses: pnpm/action-setup@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: pnpm

      - name: Install dependencies
        run: pnpm install

      - name: Typecheck desktop
        run: pnpm --filter @repo/desktop typecheck

  # ──────────────────────────────────────────────────────────────────────────
  # 2. Cross-platform Tauri builds
  # ──────────────────────────────────────────────────────────────────────────
  build:
    name: Build (${{ matrix.name }})
    needs: typecheck
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-22.04
            platform: linux
            name: linux
          - os: windows-latest
            platform: windows
            name: windows
          - os: macos-latest
            platform: macos
            name: macos-silicon
            args: --target aarch64-apple-darwin
          # macos-intel disabled — macos-13 runner not available on free plan
          # - os: macos-13
          #   platform: macos
          #   name: macos-intel
          #   args: --target x86_64-apple-darwin
    runs-on: ${{ matrix.os }}

    steps:
      - uses: actions/checkout@v4

      # ── Linux system libraries required by WebKit + tray ────────────────
      - name: Install Linux dependencies
        if: matrix.platform == 'linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libwebkit2gtk-4.1-dev \
            build-essential \
            curl \
            wget \
            file \
            libssl-dev \
            libayatana-appindicator3-dev \
            librsvg2-dev \
            patchelf

      # ── Rust ─────────────────────────────────────────────────────────────
      - name: Setup Rust (stable)
        uses: dtolnay/rust-toolchain@stable

      - name: Add Rust target
        if: matrix.args != ''
        run: rustup target add $(echo "${{ matrix.args }}" | sed 's/--target //')

      - name: Cache Rust build artifacts
        uses: swatinem/rust-cache@v2
        with:
          workspaces: apps/desktop/src-tauri -> target
          # Separate cache key per platform+arch to avoid conflicts
          key: ${{ matrix.name }}

      # ── Node / pnpm ───────────────────────────────────────────────────────
      - uses: pnpm/action-setup@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: pnpm

      - name: Install JS dependencies
        run: pnpm install

      # ── Tauri build + optional release ───────────────────────────────────
      # On a version tag push, tauri-action creates (or updates) a GitHub
      # Release draft and attaches the platform-specific installers.
      # On a regular push/PR it just builds the artifacts locally.
      - name: Build Tauri app
        uses: tauri-apps/tauri-action@v0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          # Updater signing — add these secrets in repo Settings → Secrets.
          # Generate with:  pnpm tauri signer generate -w ~/.tauri/insta.key
          TAURI_SIGNING_PRIVATE_KEY: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY }}
          TAURI_SIGNING_PRIVATE_KEY_PASSWORD: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY_PASSWORD }}
        with:
          projectPath: apps/desktop
          tauriScript: pnpm tauri
          args: ${{ matrix.args }}
          # Release fields are only relevant when a tag is pushed.
          # tauri-action ignores them on plain branch/PR runs.
          tagName: ${{ startsWith(github.ref, 'refs/tags/') && github.ref_name || '' }}
          releaseName: Insta Desktop ${{ startsWith(github.ref, 'refs/tags/') && github.ref_name || '' }}
          releaseBody: |
            ## Insta Desktop ${{ github.ref_name }}

            ### Install
            | Platform | File |
            |----------|------|
            | macOS    | `.dmg` |
            | Windows  | `.msi` / `.exe` |
            | Linux    | `.deb` / `.AppImage` |

            Auto-update will prompt you when the next release is available.
          releaseDraft: true
          prerelease: false

      # ── Upload artifacts for non-release runs ────────────────────────────
      # Makes the built installers downloadable from the workflow summary
      # even when no GitHub Release is created.
      - name: Upload artifacts (linux)
        if: matrix.platform == 'linux'
        uses: actions/upload-artifact@v4
        with:
          name: installers-linux
          path: |
            apps/desktop/src-tauri/target/release/bundle/deb/*.deb
            apps/desktop/src-tauri/target/release/bundle/appimage/*.AppImage
          if-no-files-found: ignore

      - name: Upload artifacts (windows)
        if: matrix.platform == 'windows'
        uses: actions/upload-artifact@v4
        with:
          name: installers-windows
          path: |
            apps/desktop/src-tauri/target/release/bundle/msi/*.msi
            apps/desktop/src-tauri/target/release/bundle/nsis/*.exe
          if-no-files-found: ignore

      - name: Upload artifacts (macos)
        if: matrix.platform == 'macos'
        uses: actions/upload-artifact@v4
        with:
          name: installers-${{ matrix.name }}
          path: |
            apps/desktop/src-tauri/target/*/release/bundle/dmg/*.dmg
            apps/desktop/src-tauri/target/*/release/bundle/macos/*.app.tar.gz
          if-no-files-found: ignore
